<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning: Alkene - Alkyne (H√≥a H·ªçc 11)</title>
    <style>
        /* --- 1. CSS GLOBAL & VARIABLES --- */
        :root {
            --left-bg: #004d00; --left-border: #00ff00; --left-item-bg: #ffff00; --left-item-text: #0000ff;
            --center-bg: #663300; --center-border: #ff6600;
            --quiz-bg: #2d1b2d; --quiz-border: #ff99ff; --quiz-text: #ffcc99;
            --right-bg: #666600; --right-border: #ffff00;
            --btn-bg: #cccccc; --btn-text: #cc0000;
            --text-main: #ffffff;
            --success: #00ff00; --error: #ff3333; --info: #00ffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: #111; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- 2. LAYOUT 1:2:1 --- */
        .main-container { display: flex; height: 100%; padding: 10px; gap: 15px; }
        .panel {
            border-radius: 15px; padding: 15px; display: flex; flex-direction: column; position: relative;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5), inset 2px 2px 5px rgba(255,255,255,0.2);
            overflow: hidden; 
        }

        /* --- 3. UI SPECIFICS --- */
        /* LEFT PANEL */
        .col-left { flex: 1; background-color: var(--left-bg); border: 3px solid var(--left-border); box-shadow: 0 0 10px var(--left-border); }
        .menu-btn {
            background: var(--left-item-bg); color: var(--left-item-text); font-weight: bold; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; cursor: pointer; border: 2px solid #999; text-align: left; transition: 0.1s;
        }
        .menu-btn:active { transform: scale(0.98); }
        .submenu { display: none; padding-left: 15px; margin-bottom: 10px; }
        .submenu-item { background: #fffacd; color: #00008b; padding: 8px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .submenu-item:hover { background: #fff; }

        /* CENTER PANEL */
        .col-center { flex: 2; background-color: var(--center-bg); border: 3px solid var(--center-border); box-shadow: 0 0 15px var(--center-border); }
        .display-area {
            flex: 1; background: var(--quiz-bg); border: 2px solid var(--quiz-border); border-radius: 10px; padding: 20px;
            overflow-y: auto; color: var(--quiz-text); font-size: 1.1em; position: relative;
            box-shadow: 0 0 10px var(--quiz-border), inset 0 0 20px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; text-transform: uppercase; margin-bottom: 20px; text-shadow: 0 0 5px currentColor; }

        /* RIGHT PANEL SCROLL SETUP */
        .col-right { flex: 1; background-color: var(--right-bg); border: 3px solid var(--right-border); box-shadow: 0 0 10px var(--right-border); padding: 5px; }
        #rightPanelScroll {
            width: 100%; height: 100%; overflow-y: auto; padding: 10px; padding-right: 5px;
        }
        #rightPanelScroll::-webkit-scrollbar { width: 8px; }
        #rightPanelScroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #rightPanelScroll::-webkit-scrollbar-thumb { background: var(--right-border); border-radius: 4px; }

        .control-group-title { 
            text-align: center; color: yellow; font-weight: bold; margin: 20px 0 10px; 
            text-transform: uppercase; text-shadow: 0 0 5px yellow; border-bottom: 1px dashed rgba(255,255,0,0.3); padding-bottom: 5px;
        }
        .control-group-title:first-child { margin-top: 0; }

        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 5px; color: #fff; font-size: 0.9em; font-weight: bold;}
        .input-group input { 
            width: 100%; padding: 8px; font-weight: bold; text-align: center; 
            border: 2px solid #999; border-radius: 5px; background: #fff; color: #000;
        }
        .input-group input:focus { outline: none; border-color: yellow; box-shadow: 0 0 5px yellow; }

        .ctrl-btn {
            background: var(--btn-bg); color: var(--btn-text); border: 2px solid #999; padding: 10px; margin-bottom: 8px;
            border-radius: 8px; font-weight: bold; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
            cursor: default; display: block; width: 100%; font-size: 0.9em;
        }
        
        .action-btn { cursor: pointer; transition: 0.2s; border-color: white; }
        .action-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .btn-start { 
            background: #ff0000; color: white; font-size: 1.2em; margin-top: 20px; margin-bottom: 30px;
            border: 3px solid white; box-shadow: 0 0 15px red; cursor: pointer; text-transform: uppercase;
        }

        .bottom-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .bottom-actions button {
            flex: 1; padding: 8px; background: #444; color: white; border: 1px solid #999;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em;
        }
        .bottom-actions button:hover { background: #666; }

        .audio-toggle {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 20px; cursor: pointer; color: yellow;
        }

        .stats-list { list-style: none; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; color: #ddd; font-size: 0.9em; }
        .stats-list li { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dotted #555; padding-bottom: 2px; }
        .stats-list li span { color: yellow; font-weight: bold; }

        /* --- 4. CONTENT & IMAGES --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 70%; max-height: 85%; overflow-y: auto; padding: 20px;
            border-radius: 10px; border: 4px solid var(--center-border); position: relative; animation: popIn 0.3s ease;
        }
        .modal-box.dark-mode { background: #222; color: white; border-color: var(--info); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; color: red; cursor: pointer; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .content-img, .quiz-img {
            display: block; max-width: 100%; height: auto; margin: 10px auto;
            border: 2px solid #555; border-radius: 5px;
        }
        .quiz-img { max-height: 200px; }

        /* Review Table */
        .review-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .review-table th, .review-table td { border: 1px solid #555; padding: 8px; text-align: left; vertical-align: top; }
        .review-table th { background: #444; color: yellow; text-align: center; }
        .ans-correct { color: #00ff00; font-weight: bold; }
        .ans-wrong { color: #ff3333; font-weight: bold; }

        /* --- 5. QUIZ UI --- */
        .option-btn { background: #333; color: white; padding: 12px; margin-bottom: 5px; border: 1px solid #777; cursor: pointer; border-radius: 5px; }
        .option-btn:hover { background: #555; }
        .option-btn.selected { background: var(--center-border); color: black; font-weight: bold; }
        .option-btn.correct { background: #00ff00 !important; color: black !important; }
        .option-btn.wrong { background: #ff0000 !important; color: white !important; }
        .input-text { width: 100%; padding: 10px; font-size: 1.1em; margin-top: 10px; background: #fff; color: #000; }
        
        /* Result Screen */
        #resultScreen { display: none; text-align: center; height: 100%; flex-direction: column; justify-content: center; }
        .big-score { font-size: 56px; color: yellow; text-shadow: 0 0 20px red; margin: 15px 0; }
        .rank-label { font-size: 28px; color: white; margin-bottom: 25px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .util-btn { padding: 10px 20px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; color: black; min-width: 120px; }
        
        .external-link { color: #00ffff; text-decoration: underline; cursor: pointer; }
        sub, sup { font-size: 0.75em; }
    </style>
</head>
<body>

    <!-- MODAL POPUP (Content) -->
    <div id="contentModal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-modal" onclick="closeModal('contentModal')">&times;</span>
            <h2 id="modalTitle" style="color: var(--center-border); border-bottom: 2px solid #ccc;"></h2>
            <div id="modalBody" style="margin-top: 15px; line-height: 1.6; color: black;"></div>
        </div>
    </div>

    <!-- MODAL POPUP (Review Result) -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-box dark-mode">
            <span class="close-modal" onclick="closeModal('reviewModal')">&times;</span>
            <h2 style="color: var(--info);">XEM K·∫æT QU·∫¢ B√ÄI L√ÄM</h2>
            <table class="review-table">
                <thead>
                    <tr>
                        <th style="width: 40%">ƒê√ÅP √ÅN H·ªÜ TH·ªêNG</th>
                        <th style="width: 60%">B√ÄI L√ÄM C·ª¶A H·ªåC SINH</th>
                    </tr>
                </thead>
                <tbody id="reviewBody"></tbody>
            </table>
            <div style="text-align: center; margin-top: 20px;">
                <button class="util-btn" style="background: #ccc;" onclick="closeModal('reviewModal')">ƒê√ìNG</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- 1. LEFT PANEL -->
        <div class="panel col-left">
            <h3 style="text-align: center; color: white; margin-bottom: 15px;">N·ªòI DUNG</h3>
            <div id="menuContainer" style="overflow-y: auto;"></div>
        </div>

        <!-- 2. CENTER PANEL -->
        <div class="panel col-center">
            <div class="display-area">
                <!-- Screen 1: Intro -->
                <div id="introScreen">
                    <h2>HYDROCARBON KH√îNG NO</h2>
                    <h3 style="text-align: center; color: white;">ALKENE - ALKYNE</h3>
                    <p style="text-align: center; margin-top: 50px; color: #ccc;">
                        Vui l√≤ng nh·∫≠p th√¥ng tin h·ªçc sinh v√† s·ªë l∆∞·ª£ng c√¢u h·ªèi ·ªü c·ªôt b√™n ph·∫£i.<br>
                        Sau ƒë√≥ nh·∫•n "B·∫Øt ƒë·∫ßu l√†m b√†i".
                    </p>
                </div>

                <!-- Screen 2: Quiz -->
                <div id="quizScreen" style="display: none;">
                    <div style="display: flex; justify-content: space-between; color: #aaa; font-size: 0.9em; margin-bottom: 10px;">
                        <span id="qTypeLabel">D·∫°ng b√†i: ...</span>
                        <span id="qCountLabel">C√¢u: 0/0</span>
                    </div>
                    <!-- Question text with innerHTML support -->
                    <div id="questionContent" style="margin-bottom: 15px;"></div>
                    
                    <div id="quizImgContainer"></div>
                    <div id="answerZone"></div>
                    
                    <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                        <button id="checkBtn" class="util-btn" style="background: cyan;" onclick="submitAnswer()">TR·∫¢ L·ªúI</button>
                        <button id="nextBtn" class="util-btn" style="background: #00ff00; display: none;" onclick="nextQuestion()">TI·∫æP THEO &rarr;</button>
                    </div>
                </div>

                <!-- Screen 3: Result -->
                <div id="resultScreen">
                    <h2 style="color: white;">K·∫æT QU·∫¢ B√ÄI L√ÄM</h2>
                    <div class="big-score" id="finalScore">0.0</div>
                    <div class="rank-label" id="finalRank">...</div>
                    <p id="sendStatus" style="min-height: 24px; margin-bottom: 10px; font-weight: bold;"></p>
                    
                    <div class="btn-group">
                        <button class="util-btn" style="background: #00ffff;" onclick="openReview()">XEM K·∫æT QU·∫¢ B√ÄI L√ÄM</button>
                        <button class="util-btn" style="background: orange;" onclick="restartGame()">L√ÄM L·∫†I</button>
                        <button class="util-btn" style="background: #00ff00;" onclick="sendResult()">G·ª¨I L·∫†I</button>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #aaa;">
                B√†i gi·∫£ng E-Learning H√≥a H·ªçc 11 - GDPT 2018
            </div>
        </div>

        <!-- 3. RIGHT PANEL -->
        <div class="panel col-right">
            <div id="rightPanelScroll">
                
                <div class="control-group-title">TH√îNG TIN H·ªåC SINH</div>
                <div class="input-group">
                    <label>M√£ H·ªçc Sinh (*)</label>
                    <input type="text" id="inpMaHS" placeholder="Nh·∫≠p m√£ s·ªë...">
                </div>
                <div class="input-group">
                    <label>H·ªç v√† T√™n (*)</label>
                    <input type="text" id="inpHoten" placeholder="Nh·∫≠p h·ªç t√™n...">
                </div>
                <div class="input-group">
                    <label>L·ªõp (*)</label>
                    <input type="text" id="inpLop" placeholder="Nh·∫≠p l·ªõp...">
                </div>

                <div class="control-group-title">C·∫§U H√åNH B√ÄI T·∫¨P</div>
                <div class="input-group">
                    <label>T·ªïng s·ªë c√¢u (N):</label>
                    <input type="number" id="inpTotal" value="10" min="5" oninput="calculateDist()">
                </div>
                
                <div class="input-group">
                    <label>PH√ÇN PH·ªêI C√ÇU H·ªéI:</label>
                    <ul class="stats-list">
                        <li>Tr·∫Øc nghi·ªám b·ªën l·ª±a ch·ªçn: <span id="statMCQ">4</span></li>
                        <li>Tr·∫Øc nghi·ªám ƒë√∫ng - sai: <span id="statTF">2</span></li>
                        <li>Tr·∫£ l·ªùi ng·∫Øn: <span id="statShort">2</span></li>
                        <li>T·ª± lu·∫≠n: <span id="statEssay">2</span></li>
                    </ul>
                </div>

                <div class="control-group-title">C√ÅC D·∫†NG B√ÄI</div>
                <div class="ctrl-btn">Tr·∫Øc nghi·ªám b·ªën l·ª±a ch·ªçn</div>
                <div class="ctrl-btn">Tr·∫Øc nghi·ªám ƒë√∫ng sai</div>
                <div class="ctrl-btn">Tr·∫£ l·ªùi ng·∫Øn</div>
                <div class="ctrl-btn">B√†i t·∫≠p t·ª± lu·∫≠n</div>

                <button class="action-btn btn-start" id="startBtn" onclick="startGame()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
                
                <div class="bottom-actions">
                    <button onclick="showIntro()">H·ªçc l·∫°i b√†i</button>
                    <button onclick="restartGame()">Reset b√†i t·∫≠p</button>
                </div>

                <div class="audio-toggle" onclick="toggleSound()">
                    <span>√Çm thanh:</span>
                    <span id="soundIcon" style="font-size: 1.5em;">üîä</span>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /* --- CONFIGURATION --- */
        const GOOGLE_SHEET_WEBAPP_URL = "PASTE_WEB_APP_URL_HERE"; 

        /* --- DATA CONTENT --- */
        const lessonData = [
            { title: "1. Kh√°i ni·ªám v√† C√¥ng th·ª©c chung", subs: [
                { t: "Hydrocarbon kh√¥ng no", c: "L√† nh·ªØng hydrocarbon trong ph√¢n t·ª≠ c√≥ ch·ª©a li√™n k·∫øt b·ªôi (li√™n k·∫øt ƒë√¥i C=C ho·∫∑c li√™n k·∫øt ba C‚â°C) ho·∫∑c c·∫£ hai.<br>V√≠ d·ª•: CH<sub>2</sub>=CH-CH<sub>3</sub>; CH‚â°C-CH<sub>3</sub>" },
                { t: "Alkene (Olefin)", c: "L√† hydrocarbon kh√¥ng no, m·∫°ch h·ªü, ph√¢n t·ª≠ c√≥ m·ªôt li√™n k·∫øt ƒë√¥i (C=C).<br>C√¥ng th·ª©c chung: C<sub>n</sub>H<sub>2n</sub> (n ‚â• 2).<br>Ch·∫•t ƒë∆°n gi·∫£n nh·∫•t: Ethene CH<sub>2</sub>=CH<sub>2</sub>." },
                { t: "Alkyne", c: "L√† hydrocarbon kh√¥ng no, m·∫°ch h·ªü, ph√¢n t·ª≠ c√≥ m·ªôt li√™n k·∫øt ba (C ‚â°C).<br>C√¥ng th·ª©c chung: C<sub>n</sub>H<sub>2n-2</sub> (n ‚â• 2).<br>Ch·∫•t ƒë∆°n gi·∫£n nh·∫•t: Ethyne CH‚â°CH." }
            ]},
            { title: "2. ƒê·ªìng ph√¢n", subs: [
                { t: "ƒê·ªìng ph√¢n c·∫•u t·∫°o", c: "G·ªìm ƒë·ªìng ph√¢n v·ªÅ v·ªã tr√≠ li√™n k·∫øt b·ªôi v√† ƒë·ªìng ph√¢n v·ªÅ m·∫°ch carbon.<br>Alkene v√† alkyne c√≥ t·ª´ 4 nguy√™n t·ª≠ C tr·ªü l√™n m·ªõi c√≥ ƒë·ªìng ph√¢n c·∫•u t·∫°o.<br><br><b>ƒê·ªìng ph√¢n v·ªã tr√≠ li√™n k·∫øt b·ªôi</b><br>V√≠ d·ª• 1: Ankene c√≥ c√¥ng th·ª©c ph√¢n t·ª≠ C<sub>4</sub>H<sub>8</sub> c√≥ 2 ƒë·ªìng ph√¢n c·∫•u t·∫°o d·∫°ng v·ªã tr√≠ li√™n k·∫øt ƒë√¥i l√†:<br>CH<sub>2</sub> = CH - CH<sub>2</sub> -CH<sub>3</sub> v√† CH<sub>3</sub> - CH = CH - CH<sub>3</sub><br>V√≠ d·ª• 2: Ankyne c√≥ c√¥ng th·ª©c ph√¢n t·ª≠ C<sub>5</sub>H<sub>8</sub> c√≥ 2 ƒë·ªìng ph√¢n c·∫•u t·∫°o d·∫°ng v·ªã tr√≠ li√™n k·∫øt ba l√†:<br>CH ‚â° C - CH<sub>2</sub> - CH<sub>2</sub> - CH<sub>3</sub> v√† CH<sub>3</sub> - C ‚â° C - CH<sub>2</sub> - CH<sub>3</sub><br><br><b>ƒê·ªìng ph√¢n m·∫°ch carbon</b><br>V√≠ d·ª• 1: Ankene c√≥ c√¥ng th·ª©c ph√¢n t·ª≠ C<sub>4</sub>H<sub>8</sub> c√≥ 2 ƒë·ªìng ph√¢n c·∫•u t·∫°o d·∫°ng m·∫°ch carbon l√†:<br>CH<sub>2</sub> = CH - CH<sub>2</sub> -CH<sub>3</sub> v√† CH<sub>2</sub> = C(CH<sub>3</sub>)<sub>2</sub><br>V√≠ d·ª• 2: Ankyne c√≥ c√¥ng th·ª©c ph√¢n t·ª≠ C<sub>5</sub>H<sub>8</sub> c√≥ 2 ƒë·ªìng ph√¢n c·∫•u t·∫°o d·∫°ng m·∫°ch carbon l√†:<br>CH ‚â° C - CH<sub>2</sub> - CH<sub>2</sub> - CH<sub>3</sub> v√† CH ‚â° C - CH(CH<sub>3</sub>)<sub>2</sub>" },
                { t: "ƒê·ªìng ph√¢n h√¨nh h·ªçc (Alkene)", c: "Xu·∫•t hi·ªán khi m·ªói nguy√™n t·ª≠ carbon ·ªü li√™n k·∫øt ƒë√¥i li√™n k·∫øt v·ªõi c√°c nh√≥m nguy√™n t·ª≠ kh√°c nhau.<br><br><b>+ ƒê·ªìng ph√¢n cis-:</b> M·∫°ch ch√≠nh n·∫±m v·ªÅ c√πng m·ªôt ph√≠a c·ªßa li√™n k·∫øt ƒë√¥i.<br><a class='external-link' href='https://molview.org/?cid=12628' target='_blank'>[Xem MolView: cis-but-2-ene]</a><br><br><b>+ ƒê·ªìng ph√¢n trans-:</b> M·∫°ch ch√≠nh n·∫±m v·ªÅ hai ph√≠a kh√°c nhau c·ªßa li√™n k·∫øt ƒë√¥i.<br><a class='external-link' href='https://molview.org/?cid=638069' target='_blank'>[Xem MolView: trans-but-2-ene]</a>" }
            ]},
            { title: "3. Danh ph√°p (C√°ch g·ªçi t√™n)", subs: [
                { t: "T√™n g·ªçi thay th·∫ø", c: "<b>Quy t·∫Øc ƒë√°nh s·ªë:</b> ƒê√°nh s·ªë m·∫°ch ch√≠nh t·ª´ ph√≠a g·∫ßn li√™n k·∫øt b·ªôi h∆°n.<br><b>C√¥ng th·ª©c g·ªçi t√™n:</b><br>S·ªë ch·ªâ v·ªã tr√≠ nh√°nh - T√™n nh√°nh + T√™n ti·ªÅn t·ªë (m·∫°ch ch√≠nh) - S·ªë ch·ªâ v·ªã tr√≠ li√™n k·∫øt b·ªôi - T√™n h·∫≠u t·ªë.<br>H·∫≠u t·ªë c·ªßa Alkene l√† -ene.<br>H·∫≠u t·ªë c·ªßa Alkyne l√† -yne.<br>V√≠ d·ª• 1, alkene sau: CH<sub>2</sub> = C(CH<sub>3</sub>)-CH<sub>2</sub>-CH<sub>3</sub> g·ªçi l√† 2 - methylbtut - 1 - ene<br>V√≠ d·ª• 2, alkyne sau: CH ‚â° C-CH(CH<sub>3</sub>)-CH<sub>3</sub> g·ªçi l√† 3 - methylbtut - 1 - yne" },
                { t: "T√™n g·ªçi ƒë·ªìng ph√¢n h√¨nh h·ªçc", c: "Th√™m ti·ªÅn t·ªë cis- ho·∫∑c trans- tr∆∞·ªõc t√™n g·ªçi v√† ngƒÉn c√°ch b·∫±ng d·∫•u g·∫°ch n·ªëi.<br>V√≠ d·ª•: cis-but-2-ene; trans-but-2-ene" },
                { t: "T√™n g·ªçi th√¥ng th∆∞·ªùng", c: "<b>Ankene:</b><br>T√™n th√¥ng th∆∞·ªùng alkene = T√™n ti·ªÅn t·ªë + ylen<br>M·ªôt s·ªë alkene c√≥ t√™n g·ªçi th√¥ng th∆∞·ªùng.<br>CH<sub>2</sub>=CH<sub>2</sub> (Ethylene)<br>CH<sub>2</sub>=CH-CH<sub>3</sub> (Propylene)<br>CH<sub>2</sub>=C(CH<sub>3</sub>)<sub>2</sub> (Isobutylene)<br><br><b>Alkyne:</b><br>T√™n th√¥ng th∆∞·ªùng alkyne = T√™n nh√≥m th·∫ø (t√™n nh√°nh) + acetylene<br>M·ªôt s·ªë alkyne c√≥ t√™n g·ªçi th√¥ng th∆∞·ªùng.<br>CH‚â°CH (Acetylene)<br>CH‚â°C-CH<sub>3</sub> (Methylacetylene)<br>CH<sub>3</sub>-C‚â°C-CH<sub>3</sub> (Dimethylacetylene)<br>CH‚â°C-CH<sub>2</sub>-CH<sub>3</sub> (Ethylacetylene)" }
            ]},
            { title: "4. T√≠nh ch·∫•t v·∫≠t l√≠", subs: [
                { t: "Tr·∫°ng th√°i", c: "S·ªë nguy√™n t·ª≠ Carbon < 5 (t·ª´ C2 ƒë·∫øn C4): T·ªìn t·∫°i ·ªü th·ªÉ kh√≠ (tr·ª´ ch·∫•t but-2-yne l√† l·ªèng/r·∫Øn do nhi·ªát ƒë·ªô s√¥i cao h∆°n).<br>M·∫°ch carbon d√†i h∆°n (C5): T·ªìn t·∫°i ·ªü th·ªÉ l·ªèng ho·∫∑c r·∫Øn." },
                { t: "Nhi·ªát ƒë·ªô s√¥i v√† n√≥ng ch·∫£y", c: "TƒÉng d·∫ßn theo chi·ªÅu tƒÉng c·ªßa kh·ªëi l∆∞·ª£ng ph√¢n t·ª≠, nh∆∞ng th∆∞·ªùng th·∫•p h∆°n alkane c√πng m·∫°ch carbon." },
                { t: "ƒê·ªô tan & Kh·ªëi l∆∞·ª£ng ri√™ng", c: "<b>ƒê·ªô tan:</b> H·∫ßu nh∆∞ kh√¥ng tan trong n∆∞·ªõc (do k√©m ph√¢n c·ª±c) nh∆∞ng tan t·ªët trong dung m√¥i h·ªØu c∆° (methanol, acetone...).<br><b>Kh·ªëi l∆∞·ª£ng ri√™ng:</b> Nh·∫π h∆°n n∆∞·ªõc, th∆∞·ªùng n·∫±m trong kho·∫£ng 0,6 - 0.8 g/mL." }
            ]}
        ];

        /* --- EXTENDED QUESTION BANK (NO REACTIONS - PURE THEORY) --- */
        const qBank = [
            // --- MCQ (TR·∫ÆC NGHI·ªÜM 4 L·ª∞A CH·ªåN) ---
            // Concepts & Formulas
            { type: 1, q: "C√¥ng th·ª©c ph√¢n t·ª≠ chung c·ªßa alkene l√† g√¨?", opts: ["C<sub>n</sub>H<sub>2n</sub> (n ‚â• 2)", "C<sub>n</sub>H<sub>2n+2</sub> (n ‚â• 1)", "C<sub>n</sub>H<sub>2n-2</sub> (n ‚â• 2)", "C<sub>n</sub>H<sub>2n-6</sub> (n ‚â• 6)"], a: 0 },
            { type: 1, q: "C√¥ng th·ª©c ph√¢n t·ª≠ chung c·ªßa alkyne l√† g√¨?", opts: ["C<sub>n</sub>H<sub>2n-2</sub> (n ‚â• 2)", "C<sub>n</sub>H<sub>2n</sub> (n ‚â• 2)", "C<sub>n</sub>H<sub>2n+2</sub> (n ‚â• 1)", "C<sub>n</sub>H<sub>2n-6</sub> (n ‚â• 6)"], a: 0 },
            { type: 1, q: "Hydrocarbon kh√¥ng no l√† hydrocarbon trong ph√¢n t·ª≠ c√≥ ch·ª©a:", opts: ["Li√™n k·∫øt b·ªôi (ƒë√¥i ho·∫∑c ba)", "Ch·ªâ li√™n k·∫øt ƒë∆°n", "V√≤ng benzen", "Nh√≥m ch·ª©c alcohol"], a: 0 },
            { type: 1, q: "Alkene l√† hydrocarbon kh√¥ng no, m·∫°ch h·ªü, ph√¢n t·ª≠ c√≥ ch·ª©a:", opts: ["M·ªôt li√™n k·∫øt ƒë√¥i C=C", "M·ªôt li√™n k·∫øt ba C‚â°C", "Hai li√™n k·∫øt ƒë√¥i C=C", "Ch·ªâ li√™n k·∫øt ƒë∆°n C-C"], a: 0 },
            { type: 1, q: "Alkyne l√† hydrocarbon kh√¥ng no, m·∫°ch h·ªü, ph√¢n t·ª≠ c√≥ ch·ª©a:", opts: ["M·ªôt li√™n k·∫øt ba C‚â°C", "M·ªôt li√™n k·∫øt ƒë√¥i C=C", "Hai li√™n k·∫øt ba C‚â°C", "V√≤ng no"], a: 0 },
            { type: 1, q: "Ch·∫•t n√†o sau ƒë√¢y l√† ch·∫•t ƒë∆°n gi·∫£n nh·∫•t c·ªßa d√£y ƒë·ªìng ƒë·∫≥ng alkene?", opts: ["Ethene (CH<sub>2</sub>=CH<sub>2</sub>)", "Ethyne (CH‚â°CH)", "Propene (CH<sub>2</sub>=CH-CH<sub>3</sub>)", "Methane (CH<sub>4</sub>)"], a: 0 },
            { type: 1, q: "Ch·∫•t n√†o sau ƒë√¢y l√† ch·∫•t ƒë∆°n gi·∫£n nh·∫•t c·ªßa d√£y ƒë·ªìng ƒë·∫≥ng alkyne?", opts: ["Ethyne (CH‚â°CH)", "Ethene (CH<sub>2</sub>=CH<sub>2</sub>)", "Propyne (CH‚â°C-CH<sub>3</sub>)", "Ethane (CH<sub>3</sub>-CH<sub>3</sub>)"], a: 0 },
            
            // Isomers
            { type: 1, q: "Alkene v√† alkyne b·∫Øt ƒë·∫ßu c√≥ ƒë·ªìng ph√¢n c·∫•u t·∫°o khi s·ªë nguy√™n t·ª≠ carbon l√†:", opts: ["4 tr·ªü l√™n", "3 tr·ªü l√™n", "2 tr·ªü l√™n", "5 tr·ªü l√™n"], a: 0 },
            { type: 1, q: "ƒê·ªìng ph√¢n c·∫•u t·∫°o c·ªßa alkene v√† alkyne bao g·ªìm:", opts: ["V·ªã tr√≠ li√™n k·∫øt b·ªôi v√† m·∫°ch carbon", "Ch·ªâ m·∫°ch carbon", "Ch·ªâ v·ªã tr√≠ li√™n k·∫øt b·ªôi", "ƒê·ªìng ph√¢n nh√≥m ch·ª©c"], a: 0 },
            { type: 1, q: "ƒêi·ªÅu ki·ªán ƒë·ªÉ alkene c√≥ ƒë·ªìng ph√¢n h√¨nh h·ªçc l√†:", opts: ["M·ªói C ·ªü li√™n k·∫øt ƒë√¥i li√™n k·∫øt v·ªõi 2 nh√≥m th·∫ø kh√°c nhau", "C√≥ li√™n k·∫øt ba", "M·∫°ch carbon ph√¢n nh√°nh", "C√≥ √≠t nh·∫•t 4 nguy√™n t·ª≠ carbon"], a: 0 },
            { type: 1, q: "Alkene n√†o sau ƒë√¢y c√≥ ƒë·ªìng ph√¢n h√¨nh h·ªçc?", opts: ["But-2-ene", "But-1-ene", "Propene", "Ethene"], a: 0 },
            { type: 1, q: "Trong ƒë·ªìng ph√¢n cis-, m·∫°ch ch√≠nh n·∫±m ·ªü v·ªã tr√≠ n√†o so v·ªõi li√™n k·∫øt ƒë√¥i?", opts: ["C√πng m·ªôt ph√≠a", "Hai ph√≠a kh√°c nhau", "Vu√¥ng g√≥c", "Xen k·∫Ω nhau"], a: 0 },
            { type: 1, q: "Trong ƒë·ªìng ph√¢n trans-, m·∫°ch ch√≠nh n·∫±m ·ªü v·ªã tr√≠ n√†o so v·ªõi li√™n k·∫øt ƒë√¥i?", opts: ["Hai ph√≠a kh√°c nhau", "C√πng m·ªôt ph√≠a", "Vu√¥ng g√≥c", "Tr√πng nhau"], a: 0 },
            
            // Nomenclature
            { type: 1, q: "Theo danh ph√°p thay th·∫ø, h·∫≠u t·ªë c·ªßa alkene l√†:", opts: ["-ene", "-yne", "-ane", "-ol"], a: 0 },
            { type: 1, q: "Theo danh ph√°p thay th·∫ø, h·∫≠u t·ªë c·ªßa alkyne l√†:", opts: ["-yne", "-ene", "-ane", "-al"], a: 0 },
            { type: 1, q: "T√™n g·ªçi th√¥ng th∆∞·ªùng c·ªßa CH<sub>2</sub>=CH<sub>2</sub> l√†:", opts: ["Ethylene", "Acetylene", "Propylene", "Butylene"], a: 0 },
            { type: 1, q: "T√™n g·ªçi th√¥ng th∆∞·ªùng c·ªßa CH‚â°CH l√†:", opts: ["Acetylene", "Ethylene", "Methylacetylene", "Propylene"], a: 0 },
            { type: 1, q: "Quy t·∫Øc ƒë√°nh s·ªë m·∫°ch ch√≠nh c·ªßa hydrocarbon kh√¥ng no l√†:", opts: ["T·ª´ ph√≠a g·∫ßn li√™n k·∫øt b·ªôi h∆°n", "T·ª´ ph√≠a g·∫ßn nh√°nh h∆°n", "T·ª´ tr√°i sang ph·∫£i", "B·∫•t k·ª≥ ƒë·∫ßu n√†o"], a: 0 },

            // Physical Properties
            { type: 1, q: "·ªû ƒëi·ªÅu ki·ªán th∆∞·ªùng, c√°c alkene v√† alkyne t·ª´ C2 ƒë·∫øn C4 t·ªìn t·∫°i ·ªü tr·∫°ng th√°i:", opts: ["Kh√≠", "L·ªèng", "R·∫Øn", "Plasma"], a: 0 },
            { type: 1, q: "ƒê·∫∑c ƒëi·ªÉm v·ªÅ ƒë·ªô tan c·ªßa alkene v√† alkyne l√†:", opts: ["H·∫ßu nh∆∞ kh√¥ng tan trong n∆∞·ªõc", "Tan v√¥ h·∫°n trong n∆∞·ªõc", "Tan t·ªët trong n∆∞·ªõc n√≥ng", "T·∫°o k·∫øt t·ªßa v·ªõi n∆∞·ªõc"], a: 0 },
            { type: 1, q: "So v·ªõi alkane c√πng m·∫°ch carbon, nhi·ªát ƒë·ªô s√¥i c·ªßa alkene v√† alkyne th∆∞·ªùng:", opts: ["Th·∫•p h∆°n", "Cao h∆°n r·∫•t nhi·ªÅu", "B·∫±ng nhau tuy·ªát ƒë·ªëi", "Kh√¥ng x√°c ƒë·ªãnh"], a: 0 },
            { type: 1, q: "Kh·ªëi l∆∞·ª£ng ri√™ng c·ªßa alkene v√† alkyne th∆∞·ªùng n·∫±m trong kho·∫£ng:", opts: ["0.6 - 0.8 g/mL (nh·∫π h∆°n n∆∞·ªõc)", "1.0 - 1.2 g/mL (n·∫∑ng h∆°n n∆∞·ªõc)", "> 1.5 g/mL", "B·∫±ng kh·ªëi l∆∞·ª£ng ri√™ng c·ªßa n∆∞·ªõc"], a: 0 },

            // --- TF (TR·∫ÆC NGHI·ªÜM ƒê√öNG - SAI) ---
            { type: 2, q: "Hydrocarbon kh√¥ng no ch·ªâ ch·ª©a li√™n k·∫øt ƒë∆°n trong ph√¢n t·ª≠.", a: 1 }, // S
            { type: 2, q: "C√¥ng th·ª©c chung c·ªßa alkene l√† CnH2n v·ªõi n ‚â• 2.", a: 0 }, // ƒê
            { type: 2, q: "But-2-yne t·ªìn t·∫°i ·ªü th·ªÉ kh√≠ ·ªü ƒëi·ªÅu ki·ªán th∆∞·ªùng.", a: 1 }, // S (l·ªèng/r·∫Øn do nhi·ªát ƒë·ªô s√¥i cao h∆°n)
            { type: 2, q: "Alkene tan t·ªët trong c√°c dung m√¥i h·ªØu c∆° nh∆∞ methanol, acetone.", a: 0 }, // ƒê
            { type: 2, q: "ƒê·ªìng ph√¢n h√¨nh h·ªçc ch·ªâ xu·∫•t hi·ªán ·ªü alkyne.", a: 1 }, // S (·ªü alkene)
            { type: 2, q: "Ethene v√† Ethyne ƒë·ªÅu nh·∫π h∆°n n∆∞·ªõc.", a: 0 }, // ƒê
            { type: 2, q: "ƒê·ªÉ g·ªçi t√™n alkene, ta ƒë√°nh s·ªë m·∫°ch ch√≠nh b·∫Øt ƒë·∫ßu t·ª´ ph√≠a g·∫ßn nh√°nh nh·∫•t.", a: 1 }, // S (g·∫ßn li√™n k·∫øt b·ªôi)
            { type: 2, q: "Ch·∫•t CH2=C(CH3)2 c√≥ t√™n th√¥ng th∆∞·ªùng l√† Isobutylene.", a: 0 }, // ƒê

            // --- SHORT (TR·∫¢ L·ªúI NG·∫ÆN) ---
            { type: 3, q: "S·ªë nguy√™n t·ª≠ carbon trong ph√¢n t·ª≠ Propylene l√† bao nhi√™u?", a: "3" },
            { type: 3, q: "T√™n thay th·∫ø c·ªßa CH2=CH-CH3 l√† g√¨? (vi·∫øt th∆∞·ªùng to√†n b·ªô)", a: "propene" },
            { type: 3, q: "S·ªë li√™n k·∫øt ba trong ph√¢n t·ª≠ Acetylene l√† bao nhi√™u?", a: "1" },
            { type: 3, q: "Alkene c√≥ 4 nguy√™n t·ª≠ carbon c√≥ bao nhi√™u ƒë·ªìng ph√¢n c·∫•u t·∫°o (m·∫°ch v√† v·ªã tr√≠)?", a: "3" }, // but-1-ene, but-2-ene, isobutylene
            { type: 3, q: "T√™n th√¥ng th∆∞·ªùng c·ªßa alkyne CH‚â°C-CH3 l√† g√¨? (vi·∫øt li·ªÅn, vi·∫øt th∆∞·ªùng)", a: "methylacetylene" },
            { type: 3, q: "S·ªë nguy√™n t·ª≠ Hydrogen trong ph√¢n t·ª≠ Ethene l√† bao nhi√™u?", a: "4" },

            // --- ESSAY (T·ª∞ LU·∫¨N) ---
            { type: 4, q: "So s√°nh nhi·ªát ƒë·ªô s√¥i c·ªßa alkene v·ªõi alkane t∆∞∆°ng ·ª©ng c√πng m·∫°ch carbon v√† gi·∫£i th√≠ch ng·∫Øn g·ªçn xu h∆∞·ªõng.", k: ["th·∫•p h∆°n", "kh·ªëi l∆∞·ª£ng", "t∆∞∆°ng t√°c"] },
            { type: 4, q: "ƒêi·ªÅu ki·ªán c·∫ßn v√† ƒë·ªß ƒë·ªÉ m·ªôt alkene c√≥ ƒë·ªìng ph√¢n h√¨nh h·ªçc l√† g√¨?", k: ["li√™n k·∫øt ƒë√¥i", "nh√≥m th·∫ø kh√°c nhau", "carbon"] },
            { type: 4, q: "Tr√¨nh b√†y s·ª± bi·∫øn ƒë·ªïi tr·∫°ng th√°i v·∫≠t l√Ω c·ªßa alkene khi s·ªë nguy√™n t·ª≠ carbon tƒÉng d·∫ßn.", k: ["kh√≠", "l·ªèng", "r·∫Øn", "tƒÉng d·∫ßn"] },
            { type: 4, q: "T·∫°i sao alkene v√† alkyne kh√¥ng tan trong n∆∞·ªõc nh∆∞ng tan trong dung m√¥i h·ªØu c∆°?", k: ["k√©m ph√¢n c·ª±c", "kh√¥ng ph√¢n c·ª±c", "h·ªØu c∆°"] }
        ];

        /* --- SYSTEM STATE --- */
        let gameState = {
            questions: [], idx: 0, answers: [], rawScore: 0, sound: true
        };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        /* --- INITIALIZATION --- */
        window.onload = function() {
            renderMenu();
            calculateDist();
        };

        function calculateDist() {
            let N = parseInt(document.getElementById('inpTotal').value) || 10;
            if (N < 5) { N = 5; document.getElementById('inpTotal').value = 5; }
            
            let pTF = Math.floor(N * 0.2);
            let pShort = Math.floor(N * 0.2);
            let pEssay = Math.floor(N * 0.2);
            let pMCQ = N - (pTF + pShort + pEssay);

            document.getElementById('statMCQ').innerText = pMCQ;
            document.getElementById('statTF').innerText = pTF;
            document.getElementById('statShort').innerText = pShort;
            document.getElementById('statEssay').innerText = pEssay;

            return { N, pMCQ, pTF, pShort, pEssay };
        }

        /* --- UI HANDLERS --- */
        function renderMenu() {
            const container = document.getElementById('menuContainer');
            container.innerHTML = "";
            lessonData.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'menu-btn';
                btn.innerHTML = item.title;
                btn.onclick = () => {
                    const sub = btn.nextElementSibling;
                    sub.style.display = sub.style.display === 'block' ? 'none' : 'block';
                };
                container.appendChild(btn);
                
                const sub = document.createElement('div');
                sub.className = 'submenu';
                item.subs.forEach(s => {
                    const si = document.createElement('div');
                    si.className = 'submenu-item';
                    si.innerHTML = "‚Ä¢ " + s.t;
                    si.onclick = () => openModalContent(s.t, s.c);
                    sub.appendChild(si);
                });
                container.appendChild(sub);
            });
        }

        function openModalContent(t, c) {
            document.getElementById('modalTitle').innerHTML = t;
            document.getElementById('modalBody').innerHTML = c;
            document.getElementById('contentModal').style.display = 'flex';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function showIntro() {
            document.getElementById('introScreen').style.display = 'block';
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
        }

        /* --- HELPERS: SHUFFLE --- */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function prepareQuestion(qOriginal) {
            // Deep clone to avoid modifying the const bank
            let q = JSON.parse(JSON.stringify(qOriginal));
            
            // If MCQ, shuffle options and update index
            if (q.type === 1) {
                let paired = q.opts.map((txt, i) => ({ txt: txt, isCorrect: i === q.a }));
                shuffleArray(paired);
                q.opts = paired.map(p => p.txt);
                q.a = paired.findIndex(p => p.isCorrect);
            }
            return q;
        }

        /* --- GAME LOGIC --- */
        function startGame() {
            const ma = document.getElementById('inpMaHS').value.trim();
            const ten = document.getElementById('inpHoten').value.trim();
            const lop = document.getElementById('inpLop').value.trim();
            if(!ma || !ten || !lop) { alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß: M√£ h·ªçc sinh, H·ªç v√† t√™n v√† L·ªõp!"); return; }

            const dist = calculateDist();
            
            // Function to get shuffled subset of questions
            const getQ = (type, count) => {
                let pool = qBank.filter(q => q.type === type);
                shuffleArray(pool); // Shuffle the pool first
                let selected = [];
                for(let i=0; i<count; i++) {
                    // Loop if pool is smaller than count (rare with this bank size)
                    selected.push(prepareQuestion(pool[i % pool.length]));
                }
                return selected;
            };

            // Get questions by type
            let finalQ = [
                ...getQ(1, dist.pMCQ),
                ...getQ(2, dist.pTF),
                ...getQ(3, dist.pShort),
                ...getQ(4, dist.pEssay)
            ];

            // Shuffle the order of questions presented to user
            shuffleArray(finalQ);

            gameState.questions = finalQ;
            gameState.idx = 0;
            gameState.rawScore = 0;
            gameState.answers = [];

            toggleInputs(true);
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';

            renderQuestion();
        }

        function toggleInputs(lock) {
            ['inpMaHS','inpHoten','inpLop','inpTotal','startBtn'].forEach(id => {
                document.getElementById(id).disabled = lock;
            });
        }

        /* --- RENDER QUESTION --- */
        function renderQuestion() {
            const q = gameState.questions[gameState.idx];
            const types = ["", "Tr·∫Øc nghi·ªám b·ªën l·ª±a ch·ªçn", "Tr·∫Øc nghi·ªám ƒë√∫ng - sai", "Tr·∫£ l·ªùi ng·∫Øn", "T·ª± lu·∫≠n"];
            
            document.getElementById('qTypeLabel').innerText = types[q.type];
            document.getElementById('qCountLabel').innerText = `C√¢u ${gameState.idx + 1}/${gameState.questions.length}`;
            
            // IMPORTANT: Use innerHTML to render HTML tags like <sub>
            document.getElementById('questionContent').innerHTML = q.q;

            const imgBox = document.getElementById('quizImgContainer');
            imgBox.innerHTML = '';
            if(q.img) {
                imgBox.innerHTML = `<img src="${q.img}" class="quiz-img" onerror="this.style.display='none'">`;
            }

            const zone = document.getElementById('answerZone');
            zone.innerHTML = '';
            document.getElementById('checkBtn').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';

            if(q.type === 1 || q.type === 2) {
                const opts = q.type === 1 ? q.opts : ["ƒê√∫ng", "Sai"];
                opts.forEach((txt, i) => {
                    const b = document.createElement('div');
                    b.className = 'option-btn';
                    // IMPORTANT: innerHTML here too for options
                    b.innerHTML = txt;
                    b.dataset.val = i;
                    b.onclick = () => selectOpt(b);
                    zone.appendChild(b);
                });
            } else if(q.type === 3) {
                zone.innerHTML = `<input id="userInp" class="input-text" placeholder="Nh·∫≠p ƒë√°p √°n...">`;
            } else {
                zone.innerHTML = `<textarea id="userInp" class="input-text" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>`;
            }
        }

        let curSel = null;
        function selectOpt(el) {
            if(curSel) curSel.classList.remove('selected');
            curSel = el; el.classList.add('selected');
        }

        /* --- SCORING --- */
        function submitAnswer() {
            const q = gameState.questions[gameState.idx];
            let isCorr = false, userTxt = "Ch∆∞a l√†m", sysAns = "";
            const d = calculateDist();
            const counts = {1: d.pMCQ, 2: d.pTF, 3: d.pShort, 4: d.pEssay};
            const pts = {1: 4, 2: 2, 3: 2, 4: 2};
            const val = pts[q.type] / (counts[q.type] || 1);

            if(q.type <= 2) {
                if(!curSel) { alert("Vui l√≤ng ch·ªçn ƒë√°p √°n!"); return; }
                const uVal = parseInt(curSel.dataset.val);
                isCorr = (uVal === q.a);
                userTxt = curSel.innerHTML; // Keeps subscripts in review log
                sysAns = q.type===1 ? q.opts[q.a] : (q.a===0?"ƒê√∫ng":"Sai");
                
                const all = document.querySelectorAll('.option-btn');
                all[q.a].classList.add('correct');
                if(!isCorr) curSel.classList.add('wrong');
            } else {
                const inp = document.getElementById('userInp');
                userTxt = inp.value.trim();
                if(!userTxt) { alert("Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi!"); return; }
                
                if(q.type === 3) {
                    isCorr = (userTxt.toLowerCase() === q.a.toLowerCase());
                    sysAns = q.a;
                } else {
                    let match = 0;
                    q.k.forEach(k => { if(userTxt.toLowerCase().includes(k)) match++; });
                    isCorr = (match > 0);
                    sysAns = "√ù ch√≠nh: " + q.k.join(", ");
                }
                inp.style.border = isCorr ? "2px solid #0f0" : "2px solid #f00";
            }

            if(isCorr) gameState.rawScore += val;
            playSound(isCorr);

            gameState.answers.push({
                idx: gameState.idx + 1,
                q: q.q,
                u: userTxt,
                s: sysAns,
                corr: isCorr
            });

            curSel = null;
            document.getElementById('checkBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
        }

        function nextQuestion() {
            if(++gameState.idx < gameState.questions.length) {
                renderQuestion();
            } else {
                showResult();
            }
        }

        /* --- RESULT & REVIEW --- */
        function showResult() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'flex';
            
            let final = Math.round(gameState.rawScore * 10) / 10;
            if(final > 10) final = 10;
            
            document.getElementById('finalScore').innerText = final;
            
            let rank = "C·∫¶N C·ªê G·∫ÆNG";
            let color = "red";
            if(final >= 9) { rank = "XU·∫§T S·∫ÆC"; color = "#00ff00"; }
            else if(final >= 8) { rank = "GI·ªéI"; color = "cyan"; }
            else if(final >= 5) { rank = "KH√Å"; color = "yellow"; }
            
            const rEl = document.getElementById('finalRank');
            rEl.innerText = rank; rEl.style.color = color;
            document.getElementById('sendStatus').innerText = "";
        }

        function openReview() {
            const tbody = document.getElementById('reviewBody');
            tbody.innerHTML = "";
            
            gameState.answers.forEach(item => {
                const tr = document.createElement('tr');
                let qHtml = `<div style="margin-bottom:5px; color:#ddd;"><b>C√¢u ${item.idx}:</b> ${item.q}</div>`;
                qHtml += `<div style="color:yellow;">ƒê.√°n ƒë√∫ng: ${item.s}</div>`;
                
                const uClass = item.corr ? "ans-correct" : "ans-wrong";
                let uHtml = `<span class="${uClass}">${item.u}</span>`;
                tr.innerHTML = `<td>${qHtml}</td><td>${uHtml}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('reviewModal').style.display = 'flex';
        }

        /* --- SEND DATA --- */
        function sendResult() {
            const ma = document.getElementById('inpMaHS').value.trim();
            const ten = document.getElementById('inpHoten').value.trim();
            const lop = document.getElementById('inpLop').value.trim();
            const status = document.getElementById('sendStatus');
            
            if(!ma || !ten || !lop) { alert("Thi·∫øu th√¥ng tin h·ªçc sinh!"); return; }
            if(GOOGLE_SHEET_WEBAPP_URL.includes("PASTE_WEB")) { alert("Ch∆∞a c·∫•u h√¨nh URL Web App!"); return; }
            if(!navigator.onLine) { alert("Kh√¥ng c√≥ m·∫°ng, kh√¥ng th·ªÉ g·ª≠i!"); return; }

            const payload = {
                ma_hoc_sinh: ma, ho_ten: ten, lop: lop,
                mon: "HoaHoc11_Hydrocarbon",
                diem: document.getElementById('finalScore').innerText,
                so_cau_dung: gameState.answers.filter(x=>x.corr).length,
                tong_cau: gameState.questions.length,
                danh_sach_cau_sai: gameState.answers.filter(x=>!x.corr).map(x=>`C${x.idx}`).join(", ")
            };

            status.innerText = "ƒêang g·ª≠i..."; status.style.color = "cyan";
            
            fetch(GOOGLE_SHEET_WEBAPP_URL, {
                method: "POST", mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).then(() => {
                status.innerText = "ƒê√£ g·ª≠i k·∫øt qu·∫£ th√†nh c√¥ng!"; status.style.color = "#00ff00";
            }).catch(e => {
                status.innerText = "L·ªói khi g·ª≠i: " + e; status.style.color = "red";
            });
        }

        /* --- UTILS --- */
        function restartGame() {
            toggleInputs(false);
            gameState = { questions: [], idx: 0, answers: [], rawScore: 0, sound: gameState.sound };
            showIntro();
            document.getElementById('sendStatus').innerText = "";
        }

        function toggleSound() {
            gameState.sound = !gameState.sound;
            document.getElementById('soundIcon').innerText = gameState.sound ? "üîä" : "üîá";
        }

        function playSound(good) {
            if(!gameState.sound) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            
            if(good) {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime+0.1);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime+0.2);
            }
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.3);
            osc.start(); osc.stop(audioCtx.currentTime+0.3);
        }
    </script>
</body>
</html>